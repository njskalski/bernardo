# Abstract

There are multiple widgets that are created from smaller pieces.

## Examples

The most prominent example is [EditorView](../../src/widgets/editor_view/editor_view.rs) that consists of:

- [Editor widget](../../src/widgets/editor_widget/editor_widget.rs) (where the text is drawn, which is quite complex in
  itself)
- Find/Replace editboxes
- [ContextMenu](../../src/widgets/context_menu/widget.rs) (that pops on ctr+e in default config, that offers options
  like "go to definition", "find usages" etc.)

Another example is ["Save as Dialog"](../../src/widgets/save_file_dialog/save_file_dialog.rs) which consists of:

- [TreeView](../../src/widgets/tree_view/tree_view.rs) (for filesystem navigation)
- [ListView](../../src/widgets/list_widget/list_widget.rs) (listing files in directory)
- Buttons (Save, Cancel)
- Editbox (to name a file)

# Goal

There are two important topics to consider when dealing with such comlpex widgets:

- focus (where input goes)
- layout (how to draw it)

## Distinction

We have two ways of dealing with sets of widgets forming a new one:

- **Complex Widgets** like "Save as Dialog", where one of widgets within is highlighted as **focused** (for example
  EditBox, where you can name new file). Complex Widgets handle "focus transfer" within it and designate "focused
  subwidget".
- **Combined Widgets** like ContextMenu, that is EditBox and TreeView considered as one. In this case, either entire
  CombineWidget is focused or not, no focus transfer is possible, and "on_input" divides input events between the
  subwidgets.

# Combined Widgets

Since combined Widgets are significantly easier, I won't spend much time describing them. Just head
to [ContextMenu Widget](../../src/widgets/context_menu/widget.rs) and look at "on_input" method and "act_on" method
override.

# Complex Widgets

## Focus

A ComplexWidget stores "Display State", that remembers sizes and positions of Widgets, and generates "Focus Graph".

Focus Graph is a structure that tells "left from widget A is B" and "down from widget A is C".

When user decides to use ALT+arrow, we update focus path within ComplexWidget to point at newly highlighted Subwidget
using Focus Graph.

## Focus transfer (focus graph)

Right now ComplexWidget implements a mechanism of generating "focus graph" from Layout with a very naive way (by
coloring an invisible buffer). Each ComplexWidget holds it's own "focus graph", we call it "internalized focus".

An alternative approach may be considered, where a global focus graph is generated for entire screen space at the end of
each frame. It would shift the responsibility for focus transfers from within a Widget outside it. It would be called "
external focus". As much this approach would be more intuitive, it would also require introducing new primitives, like "
global focus tree", that would accept and execute focus updates initiated by the widget itself.

The decision is therefore temporarily postponed whether to implement "external focus" or not.

### Arguments for "external focus"

#### Stupid Circle

Imagine a widget tree generated by introducing three subdivisions: one horizontal, and then in subtrees two vertical.

```
+---+---+
| 1 | 2 |
+---+---+
| 3 | 4 |
+---+---+
```

With "internal focus", it is impossible to move focus in circle 1-2-4-3-1 (clockwise), because on moving back up 3, it
is remembered "internally" that from the two 1 and 2, last time it was 2 that was selected, therefore a jump 1-2-4-3-2
happens, or even worse 1-2-3-4.

### Arguments against "external focus"

#### "What happens when Widget disappears"

A problem of "I was looking at Widget X but it's not there" needs to be solved. It'd be most likely done by escalating
to "latest still existing ancestor" and asking it for new subtree.

#### Longer contract on Widgets

Widget type would complicate significantly, to enable composition of global focus tree. When a Widget needs to shift the
focus internally, it would have to update that external structure. **One way to fix it is through invalidation**,
requiring the focus tree to be re-generated each frame.
